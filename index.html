<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tag Statistics History</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; color: #333; }
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { text-align: center; margin-bottom: 10px; color: #2c3e50; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 0.9em; }
        
        .controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
            padding: 20px; 
            background: #eef2f5; 
            border-radius: 6px; 
            align-items: end;
        }
        
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; }
        select { 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 1em; 
            background-color: white; 
            width: 100%; 
            box-sizing: border-box;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
        th { background-color: #343a40; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e9ecef; }
        
        .pos { color: #28a745; font-weight: bold; }
        .neg { color: #dc3545; font-weight: bold; }
        
        #loading { text-align: center; padding: 40px; font-size: 1.2em; color: #6c757d; }
        .hidden { display: none; }
        select:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>Danbooru Tag History</h1>
    <p class="subtitle" id="subtitle">Daily Tag Growth</p>
    
    <div class="controls">
        <div class="control-group">
            <label for="timeframeSelect">Timeframe</label>
            <select id="timeframeSelect" onchange="setTimeframe()">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
            </select>
        </div>
        <div class="control-group">
            <label for="dateSelect">Date / Snapshot</label>
            <select id="dateSelect" onchange="updateTable()"></select>
        </div>
        <div class="control-group">
            <label for="typeSelect">Tag Type</label>
            <select id="typeSelect" onchange="updateTable()">
                <option value="all">All</option>
                <option value="general">General</option>
                <option value="artist">Artist</option>
                <option value="series">Series</option>
                <option value="character">Character</option>
                <option value="touhou">Touhous</option>
            </select>
        </div>
        <div class="control-group">
            <label for="sortSelect">Sort By</label>
            <select id="sortSelect" onchange="updateTable()">
                <option value="percent">Growth Percentage (%)</option>
                <option value="diff">Raw Count Increase</option>
            </select>
        </div>
    </div>

    <div id="loading">Loading historical data...</div>
    <div id="table-container" class="hidden">
        <h3 id="comparison-title" style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;"></h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 40%">Tag</th>
                    <th style="width: 15%">Old</th>
                    <th style="width: 15%">New</th>
                    <th style="width: 15%">Diff</th>
                    <th style="width: 15%">%</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>
</div>

<script>
    let allData = {};
    let currentData = [];

    async function loadData() {
        try {
            const response = await fetch('tag_stats.json');
            if (!response.ok) throw new Error("Could not load tag_stats.json");
            allData = await response.json();
            
            if (Array.isArray(allData)) {
                currentData = allData;
                document.getElementById('timeframeSelect').disabled = true;
                document.getElementById('timeframeSelect').value = 'daily';
            } else {
                currentData = allData.daily || [];
                document.getElementById('timeframeSelect').disabled = false;
            }
            
            if (currentData.length === 0) {
                document.getElementById('loading').textContent = "No comparison data found.";
                return;
            }
            
            populateDateSelect();

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('table-container').classList.remove('hidden');
            
            updateTable();

        } catch (error) {
            document.getElementById('loading').innerHTML = `<span style="color:red">Error: ${error.message}<br><small>Ensure you ran: python compare_last_two.py --json</small></span>`;
        }
    }

    function setTimeframe() {
        if (Array.isArray(allData)) {
            return;
        }
        
        const timeframe = document.getElementById('timeframeSelect').value;
        currentData = allData[timeframe] || [];
        
        document.getElementById('subtitle').textContent = 
            timeframe === 'daily' ? 'Daily Tag Growth' : 'Weekly Tag Growth';
        
        populateDateSelect();
        updateTable();
    }

    function populateDateSelect() {
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.innerHTML = '';
        
        currentData.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.text = item.date;
            dateSelect.appendChild(opt);
        });
    }

    function updateTable() {
        if (currentData.length === 0) return;

        const selectedId = document.getElementById('dateSelect').value;
        const type = document.getElementById('typeSelect').value;
        const sort = document.getElementById('sortSelect').value;

        const comparison = currentData.find(c => c.id === selectedId);
        
        if (!comparison) return;

        document.getElementById('comparison-title').textContent = `Comparison for: ${comparison.date}`;

        const stats = comparison.stats[type][sort];
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        stats.forEach(item => {
            const diffClass = item.diff >= 0 ? 'pos' : 'neg';
            const diffSign = item.diff > 0 ? '+' : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:500; color:#2c3e50"><a href="https://safebooru.donmai.us/posts?tags=${encodeURIComponent(item.tag)}" target="_blank" style="color:#007bff; text-decoration:underline;">${item.tag}</a></td>
                <td>${item.old.toLocaleString()}</td>
                <td>${item.new.toLocaleString()}</td>
                <td class="${diffClass}">${diffSign}${item.diff.toLocaleString()}</td>
                <td class="${diffClass}">${item.percent.toFixed(2)}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    loadData();
</script>

</body>
</html>
